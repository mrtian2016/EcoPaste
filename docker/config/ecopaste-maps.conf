# CloudPaste Map 配置
# 这些 map 指令必须在 http 块中，因此放在 conf.d 目录

# WebSocket Connection header 映射
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# 协议映射：优先使用外层 nginx 传递的协议，否则使用当前协议
map $http_x_forwarded_proto $forwarded_proto {
    default $http_x_forwarded_proto;
    '' $scheme;
}

# 提取客户端访问的端口（从 Host 头中）
map $http_host $forwarded_port {
    "~^[^:]+:(?<p>\d+)$" $p;
    default $server_port;
}

# FastAPI 后端服务
upstream fastapi_backend {
    server 127.0.0.1:5281;
    keepalive 32;
}
